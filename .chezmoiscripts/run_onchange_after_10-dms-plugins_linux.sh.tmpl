#!/bin/bash
# Manages DankMaterialShell plugins via dms plugins CLI
# Plugins list hash: {{ .dms.plugins.enabled | toJson | sha256sum }}

set -euo pipefail

# Only run if DMS is installed
if ! command -v dms &>/dev/null; then
  echo "DMS not found, skipping plugin management"
  exit 0
fi

echo "Managing DMS plugins..."

# Get list of currently installed plugins
INSTALLED=$(dms plugins list 2>/dev/null | tail -n +2 | awk '{print $1}' || echo "")

# Install desired plugins
{{ if .dms.plugins.enabled -}}
{{ range .dms.plugins.enabled -}}
# Check if already installed
if ! grep -q "^{{ . }}$" <<<"$INSTALLED"; then
  echo "  Installing plugin: {{ . }}..."
  dms plugins install "{{ . }}" || echo "    WARNING: Failed to install {{ . }}"
else
  echo "  Plugin {{ . }} already installed"
fi
{{ end -}}
{{ end }}

# Uninstall plugins not in our list
{{ if .dms.plugins.enabled -}}
DESIRED_PLUGINS=({{ range .dms.plugins.enabled }}"{{ . }}" {{ end }})
{{ else -}}
DESIRED_PLUGINS=()
{{ end -}}

while IFS= read -r plugin; do
  [[ -z "$plugin" ]] && continue

  # Check if plugin is in our desired list
  FOUND=0
  for desired in "${DESIRED_PLUGINS[@]}"; do
    if [[ "$plugin" == "$desired" ]]; then
      FOUND=1
      break
    fi
  done

  # If not in desired list, uninstall it
  if [[ $FOUND -eq 0 ]]; then
    echo "  Removing unmanaged plugin: $plugin"
    dms plugins uninstall "$plugin" &>/dev/null || true
  fi
done <<<"$INSTALLED"

# Restart DMS to load plugins
echo "  Restarting DMS to load plugins..."
dms restart &>/dev/null || echo "    Note: DMS restart may require manual action"

echo "âœ“ DMS plugins managed"
