#!/bin/bash
# Manages DankMaterialShell plugins via dms plugins CLI
# Plugins list hash: {{ .dms.plugins.enabled | toJson | sha256sum }}

set -euo pipefail

# Only run if DMS is installed
if ! command -v dms &>/dev/null; then
  echo "DMS not found, skipping plugin management"
  exit 0
fi

echo "Managing DMS plugins..."

# Track if any changes were made
CHANGES_MADE=0

# Get list of currently installed plugins (extract IDs from multi-line format)
INSTALLED=$(dms plugins list 2>/dev/null | grep -E '^\s+ID:' | awk '{print $2}' || echo "")

# Install desired plugins
{{ if .dms.plugins.enabled -}}
{{ range .dms.plugins.enabled -}}
if ! grep -q "^{{ . }}$" <<<"$INSTALLED"; then
  echo "  Installing plugin: {{ . }}..."
  if OUTPUT=$(dms plugins install "{{ . }}" 2>&1); then
    echo "    ✓ Installed {{ . }}"
    CHANGES_MADE=1
  elif echo "$OUTPUT" | grep -q "already installed"; then
    echo "    ✓ Plugin {{ . }} already installed"
  else
    echo "    WARNING: Failed to install {{ . }}"
    echo "    Error: $OUTPUT"
  fi
else
  echo "  ✓ Plugin {{ . }} already installed"
fi
{{ end -}}
{{ end }}

# Uninstall plugins not in our list
{{ if .dms.plugins.enabled -}}
DESIRED_PLUGINS=({{ range .dms.plugins.enabled }}"{{ . }}" {{ end }})
{{ else -}}
DESIRED_PLUGINS=()
{{ end -}}

while IFS= read -r plugin; do
  [[ -z "$plugin" ]] && continue

  # Check if plugin is in our desired list
  FOUND=0
  for desired in "${DESIRED_PLUGINS[@]}"; do
    if [[ "$plugin" == "$desired" ]]; then
      FOUND=1
      break
    fi
  done

  # If not in desired list, uninstall it
  if [[ $FOUND -eq 0 ]]; then
    echo "  Removing unmanaged plugin: $plugin"
    dms plugins uninstall "$plugin" &>/dev/null || true
    CHANGES_MADE=1
  fi
done <<<"$INSTALLED"

# Restart DMS if changes were made (but not under KDE or GNOME)
if [[ $CHANGES_MADE -eq 1 ]]; then
  if [[ "${XDG_CURRENT_DESKTOP:-}" == *"KDE"* || "${XDG_CURRENT_DESKTOP:-}" == *"GNOME"* ]]; then
    echo "  Skipping DMS restart (running under $XDG_CURRENT_DESKTOP)"
  else
    echo "  Restarting DMS to load plugins..."
    dms restart &>/dev/null || echo "    Note: DMS restart may require manual action"
  fi
fi

echo "✓ DMS plugins managed"
