#!/bin/bash
# run_onchange_after - runs whenever the hash of this file or backrest.container changes
# Hash: {{ include "dot_config/containers/systemd/backrest.container" | sha256sum }}

set -euo pipefail

echo "Setting up Backrest backup service..."

# Reload systemd user daemon to pick up the new quadlet
systemctl --user daemon-reload

# Start the service if not already running
if systemctl --user is-active --quiet backrest.service; then
    echo "Backrest service already running, restarting to pick up changes..."
    systemctl --user restart backrest.service
else
    echo "Starting backrest service..."
    systemctl --user start backrest.service
fi

# Check status
if systemctl --user is-active --quiet backrest.service; then
  echo "✓ Backrest service is running"
  echo "  Access the web UI at: http://localhost:9898"
else
  echo "⚠ Backrest service failed to start"
  systemctl --user status backrest.service --no-pager || true
  exit 1
fi
