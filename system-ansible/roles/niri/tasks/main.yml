---
# Niri wayland compositor and ecosystem

- name: Niri installation and configuration
  when: niri_state == 'present'
  block:
    # Core components always installed
    - name: Install Niri core components
      become: true
      ansible.builtin.dnf:
        name: "{{ niri_core_packages }}"
        state: present

    # Traditional component-based desktop shell
    - name: Traditional desktop shell setup
      when: not niri_use_dms
      block:
        - name: Enable Hyprland COPR repository
          become: true
          community.general.copr:
            name: solopasha/hyprland
            state: enabled

        - name: Install traditional Niri ecosystem
          become: true
          ansible.builtin.dnf:
            name: "{{ niri_traditional_packages }}"
            state: present

        # Cleanup DMS if switching from DMS to traditional
        - name: Cleanup DankMaterialShell (switching to traditional)
          block:
            - name: Remove DankMaterialShell package
              become: true
              ansible.builtin.dnf:
                name: "{{ niri_dms_packages }}"
                state: absent

            - name: Disable DankMaterialShell COPR repository
              become: true
              community.general.copr:
                name: avengemedia/dms
                state: disabled

            - name: Remove DMS service wants symlink
              ansible.builtin.file:
                path: "{{ ansible_env.HOME }}/.config/systemd/user/niri.service.wants/dms.service"
                state: absent

            - name: Disable DMS service
              ansible.builtin.systemd_service:
                name: dms
                enabled: false
                scope: user
              failed_when: false

    # DankMaterialShell setup
    - name: DankMaterialShell setup
      when: niri_use_dms
      block:
        # Cleanup traditional components if switching from traditional to DMS
        - name: Cleanup traditional components (switching to DMS)
          block:
            - name: Remove traditional ecosystem packages
              become: true
              ansible.builtin.dnf:
                name: "{{ niri_traditional_packages }}"
                state: absent

            - name: Disable Hyprland COPR repository
              become: true
              community.general.copr:
                name: solopasha/hyprland
                state: disabled
              when: hyprland_state is not defined or hyprland_state != 'present'

        - name: Enable DankMaterialShell COPR repository
          become: true
          community.general.copr:
            name: avengemedia/dms
            state: enabled

        - name: Install DankMaterialShell
          become: true
          ansible.builtin.dnf:
            name: "{{ niri_dms_packages }}"
            state: present

        # Link DMS to Niri session (DMS starts when Niri session starts via GDM)
        - name: Link DMS to Niri service
          block:
            - name: Ensure niri.service.wants directory exists
              ansible.builtin.file:
                path: "{{ ansible_env.HOME }}/.config/systemd/user/niri.service.wants"
                state: directory
                mode: '0755'

            - name: Create DMS service symlink
              ansible.builtin.file:
                src: /usr/lib/systemd/user/dms.service
                dest: "{{ ansible_env.HOME }}/.config/systemd/user/niri.service.wants/dms.service"
                state: link

# Removal/cleanup when niri_state == 'absent'
- name: Niri removal
  when: niri_state == 'absent'
  block:
    - name: Remove Niri core components
      become: true
      ansible.builtin.dnf:
        name: "{{ niri_core_packages }}"
        state: absent

    - name: Remove traditional ecosystem components
      become: true
      ansible.builtin.dnf:
        name: "{{ niri_traditional_packages }}"
        state: absent

    - name: Disable Hyprland COPR repository
      become: true
      community.general.copr:
        name: solopasha/hyprland
        state: disabled
      when: hyprland_state is not defined or hyprland_state != 'present'

    - name: Remove DankMaterialShell
      become: true
      ansible.builtin.dnf:
        name: "{{ niri_dms_packages }}"
        state: absent

    - name: Disable DankMaterialShell COPR repository
      become: true
      community.general.copr:
        name: avengemedia/dms
        state: disabled

    - name: Disable DMS service
      ansible.builtin.systemd_service:
        name: dms
        enabled: false
        scope: user
      failed_when: false

    - name: Remove DMS service wants symlink
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.config/systemd/user/niri.service.wants/dms.service"
        state: absent
