---
- name: Install Docker container runtime and tooling
  become: true
  ansible.builtin.dnf:
    name:
      - moby-engine
      - docker-compose
    state: "{{ virtualization_docker_state }}"
  when: virtualization_docker_state == 'present'

- name: Ensure docker group exists
  become: true
  ansible.builtin.group:
    name: docker
    state: "{{ virtualization_docker_state }}"

- name: Add users to docker group
  become: true
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ virtualization_docker_users }}"
  when:
    - virtualization_docker_state == 'present'
    - virtualization_docker_users | length > 0

- name: Enable and start Docker service
  become: true
  ansible.builtin.systemd:
    name: docker.service
    enabled: "{{ virtualization_docker_state == 'present' }}"
    state: "{{ 'started' if virtualization_docker_state == 'present' else 'stopped' }}"
  when: virtualization_docker_state in ['present', 'absent']

- name: Remove Docker packages
  become: true
  ansible.builtin.dnf:
    name:
      - moby-engine
      - docker-compose
    state: absent
  when: virtualization_docker_state == 'absent'
