---
# btrbk - btrfs snapshot management

- name: Discover btrfs root device
  ansible.builtin.set_fact:
    btrbk_device: "{{ item.device }}"
  when: item.fstype == 'btrfs' and item.mount == '/'
  loop: "{{ ansible_mounts }}"
  register: btrbk_device_discovery

- name: Verify btrfs root device was found
  ansible.builtin.fail:
    msg: "No btrfs filesystem found mounted at /. This role requires btrfs."
  when: btrbk_device is not defined

- name: Btrbk setup
  become: true
  block:
    - name: Install btrbk
      ansible.builtin.dnf:
        name: btrbk
        state: present

    - name: Mask standard Fedora btrbk.service
      ansible.builtin.systemd_service:
        name: btrbk.service
        masked: true

    - name: Mask standard Fedora btrbk.timer
      ansible.builtin.systemd_service:
        name: btrbk.timer
        masked: true

    - name: Deploy btrfs_root.mount unit
      ansible.builtin.template:
        src: mnt-btrfs-root.mount.j2
        dest: /etc/systemd/system/mnt-btrfs_root.mount
        mode: "0644"
      notify: Systemd daemon-reload

    - name: Flush handlers to reload systemd
      ansible.builtin.meta: flush_handlers

    - name: Create btrfs root mount point
      ansible.builtin.file:
        path: /mnt/btrfs_root
        state: directory
        mode: "0755"

    - name: Enable and start btrfs_root mount
      ansible.builtin.systemd_service:
        name: mnt-btrfs_root.mount
        state: started
        enabled: true

    - name: Create btrbk configuration directory
      ansible.builtin.file:
        path: /etc/btrbk
        state: directory
        mode: "0755"

    - name: Deploy btrbk configurations and systemd units
      notify: Systemd daemon-reload
      block:
        - name: Deploy btrbk /home configuration
          ansible.builtin.template:
            src: btrbk-home.conf.j2
            dest: /etc/btrbk/btrbk-home.conf
            mode: "0644"

        - name: Deploy btrbk /root configuration
          ansible.builtin.template:
            src: btrbk-root.conf.j2
            dest: /etc/btrbk/btrbk-root.conf
            mode: "0644"

        - name: Deploy btrbk-home.timer
          ansible.builtin.copy:
            src: btrbk-home.timer
            dest: /etc/systemd/system/btrbk-home.timer
            mode: "0644"

        - name: Deploy btrbk-home.service
          ansible.builtin.copy:
            src: btrbk-home.service
            dest: /etc/systemd/system/btrbk-home.service
            mode: "0644"

        - name: Deploy btrbk-root.timer
          ansible.builtin.copy:
            src: btrbk-root.timer
            dest: /etc/systemd/system/btrbk-root.timer
            mode: "0644"

        - name: Deploy btrbk-root.service
          ansible.builtin.copy:
            src: btrbk-root.service
            dest: /etc/systemd/system/btrbk-root.service
            mode: "0644"

    - name: Flush handlers to reload systemd
      ansible.builtin.meta: flush_handlers

    - name: Enable and start btrbk timers
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        state: started
        enabled: true
        daemon_reload: true
      loop:
        - btrbk-home.timer
        - btrbk-root.timer
