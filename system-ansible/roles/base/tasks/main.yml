---
# Base system configuration - repositories and core utilities

- name: Check if ZFS kernel module is available
  ansible.builtin.command: modinfo zfs
  register: base_zfs_module_check
  changed_when: false
  failed_when: false

- name: Configure repositories and install packages
  become: true
  block:
    - name: Install RPM Fusion repositories
      ansible.builtin.dnf:
        name:
          - >-
            https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-{{
            ansible_distribution_major_version }}.noarch.rpm
          - >-
            https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{
            ansible_distribution_major_version }}.noarch.rpm
        state: present
        disable_gpg_check: true

    - name: Enable COPR repositories
      community.general.copr:
        name: scottames/ghostty
        state: enabled

    - name: Add zrepl repository
      ansible.builtin.copy:
        src: zrepl.repo
        dest: /etc/yum.repos.d/zrepl.repo
        mode: "0644"
      when: base_zfs_module_check.rc == 0

    - name: Configure YAMA ptrace scope
      ansible.posix.sysctl:
        name: kernel.yama.ptrace_scope
        value: "1"
        state: present
        sysctl_file: /etc/sysctl.d/90-yama.conf
        reload: true

    - name: Install system utilities
      ansible.builtin.dnf:
        name:
          - gdisk
          - parted
        state: present

    - name: Install zrepl
      ansible.builtin.dnf:
        name: zrepl
        state: present
      when: base_zfs_module_check.rc == 0

    - name: Install CLI tools
      ansible.builtin.dnf:
        name:
          - zsh
          - neovim
          - bsdtar
          - yp-tools
        state: present

    - name: Install networking tools
      ansible.builtin.dnf:
        name:
          - sshfs
          - NetworkManager-tui
          - network-manager-applet
          - wireguard-tools
        state: present
