#!/bin/bash

set -Eeuxo pipefail

red=$(tput setaf 1)
green=$(tput setaf 2)
reset=$(tput sgr0)

echo "${green}Installing requirements${reset}"
{{ if eq .chezmoi.osRelease.id "ubuntu" "debian" }}
    sudo apt-get update &&
        sudo apt-get -y install git git-crypt lsb-release curl myrepos zsh \
            tomb python3-pip gnupg2 pcscd scdaemon pcsc-tools \
            yubikey-manager
{{ else if eq .chezmoi.osRelease.id "arch" }}
    yay -S --noconfirm --needed git curl zsh run-parts unzip
    if ! hash mr 2>/dev/null; then
        yay -S --noconfirm --needed myrepos
    fi
{{ else if eq .chezmoi.osRelease.id "fedora" }}
    sudo dnf install -y myrepos git git-crypt zsh gocryptfs redhat-lsb-core
{{ else if eq .chezmoi.osRelease.id "opensuse-leap" "opensuse-tumbleweed" }}
    sudo zypper install -y mr git zsh
{{ end }}

echo "${green}Updating vendor dependencies${reset}"
mr -c $HOME/.vendor/.mrconfig update

echo "${green}Install fzf${reset}"
$HOME/.vendor/fzf/install --all

echo "${green}Populating ssh keys${reset}"
"${HOME}"/bin/security/populate_ssh_keys.sh

echo "${green}Installing antibody and creating static plugin list${reset}"
curl -sfL git.io/antibody | sh -s - -b $HOME/bin &&
    chmod +x $HOME/bin/antibody &&
    $HOME/bin/antibody bundle <{{ .chezmoi.homedir }}/.zsh_plugins.txt > \
        {{ .chezmoi.homedir }}/.zsh_plugins.sh

echo "${green}Changing from (possible) https to ssh${reset}"
chezmoi source remote set-url origin git@github.com:azmodude/dotfiles
