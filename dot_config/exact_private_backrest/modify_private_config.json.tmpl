#!/bin/bash
set -euo pipefail

# Check if backrest service exists
if systemctl --user list-unit-files backrest.service --no-legend --no-pager | grep -q backrest.service; then
  # Stop backrest service before modifying config
  systemctl --user stop backrest.service 2>/dev/null || true
  service_existed=true
else
  service_existed=false
fi

# Read the current file (including backrest's runtime modifications)
current=$(cat)

# Generate our source of truth from template
desired_config='{{ includeTemplate "backrest/config.json.tmpl" . }}'

# Merge: our desired config wins over backrest's changes
# --argjson declares a jq variable named "desired" with value from bash variable $desired_config
# (our source of truth)
# The jq expression '. * $desired' merges current (.) with desired ($desired), where desired wins
echo "$current" | jq --argjson desired "$desired_config" '. * $desired'

# Restart backrest service if it existed
if [[ "$service_existed" == "true" ]]; then
  systemctl --user start backrest.service 2>/dev/null || true
fi
