#!/bin/bash
# invoke emacsclient with proper socketfile.
# echo "thisthat" | ec -
# or anything piped into this script with - as argument opens it in emacs

# find emacs' socketfile to connect to
if [ "$(uname -s)" == 'Darwin' ]; then
    binary='Emacs'
else
    binary='emacs'
fi
socketfile=$(lsof -c ${binary} 2>/dev/null | grep "/server" | tr -s " " | \
    cut -d' ' -f9 | uniq | grep ${binary})

# If the argument is - then write stdin to a tempfile and open the
# tempfile.
if [[ $# -ge 1 ]] && [[ "$1" == - ]]; then
    tempfile="$(mktemp "emacs-stdin-$USER.XXXXXXX" --tmpdir)"
    cat - > "$tempfile"
    emacsclient -c -n -s "${socketfile}" \
        --eval "(find-file \"$tempfile\")" \
        --eval '(set-visited-file-name nil)' \
        --eval '(rename-buffer "*stdin*" t))'
else
    # just a normal invocation.
    if [ -z "${socketfile}" ]; then
        emacsclient -a "" -c "$@"
    else
        emacsclient -s "${socketfile}" "$@"
    fi
fi

# Local Variables:
# mode: sh
# End:
